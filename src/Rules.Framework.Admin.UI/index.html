<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>%(DocumentTitle)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link href="https://pagination.js.org/dist/2.1.5/pagination.css" rel="stylesheet">


    <link rel='stylesheet' href='css/bootstrap.min.css' />

    %(HeadContent)

    <script src="jquery.min.js"></script>

    <script src="https://pagination.js.org/dist/2.1.5/pagination.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        html {
            height: -webkit-fill-available;
        }

        main {
            height: 100vh;
            height: -webkit-fill-available;
            max-height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .b-example-divider {
            border-width: 1px;
        }

        .b-example-vr {
            flex-shrink: 0;
            width: 1.5rem;
            height: 100vh;
        }
    </style>
</head>
<body>

    <main class="d-flex flex-nowrap">

        <div class="d-flex flex-column flex-shrink-0 p-3 text-bg-dark" style="width: 280px;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <span class="fs-4 glyphicon glyphicon-knight" aria-hidden="true"></span>
                &nbsp; <span class="fs-4"> %(DocumentTitle)</span>
            </a>
            <hr>
            <ul class="main nav nav-pills flex-column mb-auto">
                <li class="main nav-item">
                    <a href="#" id="index" class="nav-link active" aria-current="page">
                        Home
                    </a>
                </li>
                <li class="main nav-item">
                    <a href="#" id="contentTypes" class="nav-link text-white">
                        Content Types
                    </a>
                </li>
                <li class="main nav-item">
                    <a href="#" id="rules" class="nav-link text-white">
                        Rules
                    </a>
                </li>
            </ul>
        </div>

        <div class="b-example-divider b-example-vr"></div>

        <div class="container" style="overflow-y:auto; padding-top:30px">
            
            <center>
                <div id="index" class="content">
                    <br />
                    <p class="lead">Welcome to Rules.Framework UI.<br /> Allows you to see what are the content types and rules configured in this application.</p>
                </div>
            </center>

            <div id="contentTypes" class="content" style="display:none">
                <div class="row">
                    <div class="col-12">
                        <form novalidate>
                            <div class="form-group row g-2 align-items-left">
                                <div class="col-sm-2">
                                    <label for="contentTypeSearch" class="form-label">Search</label>
                                </div>
                                <div class="col-sm-4">
                                    <input class="form-control" id="contentTypeSearch" />
                                </div>
                            </div>
                            <hr class="my-4">
                        </form>
                        <h5 class="mb-3">Content Types</h5>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" style="font-size: .875rem;">
                                <thead style="border-bottom: 2px solid currentcolor;">
                                    <tr>
                                        <th scope="col" width="10%">#</th>
                                        <th scope="col" width="70%">Name</th>
                                        <th scope="col" width="20%" style="text-align: center;">Rules</th>
                                    </tr>
                                </thead>
                                <tbody id="contentTypes_table">
                                </tbody>
                            </table>
                            <div id="contentTypes_pagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rules" class="content" style="display:none">
                <div class="row">
                    <div class="col-12">
                        <form novalidate>
                            <div class="form-group row g-2 align-items-left">
                                <div class="col-sm-2">
                                    <label for="contentTypesSelect" class="form-label">Content Type</label>
                                </div>
                                <div class="col-sm-4">
                                    <select class="form-select" id="contentTypesSelect" required>
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="my-4">
                        </form>
                        <div class="row">
                            <div class="col-lg-8">
                            <h5 class="mb-3">Rules</h5>
                            </div>
                            <div class="col-lg-4">
                                <em>Priority Options (<span id="rulesOptions"></span>) &nbsp; </em>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="glyphicon glyphicon-cog"></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item download" href="#"><span class="glyphicon glyphicon-cloud-download"></span> Export JSON</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" style="font-size: .875rem;">
                                <thead style="border-bottom: 2px solid currentcolor;">
                                    <tr>
                                        <th scope="col" width="1%">Priority</th>
                                        <th scope="col" width="25%">Name</th>
                                        <th scope="col" width="1%" nowrap style="text-align: center;">Date Begin</th>
                                        <th scope="col" width="1%" nowrap style="text-align: center;">Date End</th>
                                        <th scope="col" width="42%">Value</th>
                                        <th scope="col" width="10%" style="text-align: center;">Status</th>
                                        <th scope="col" width="10%" style="text-align: center;">Conditions</th>
                                    </tr>
                                </thead>
                                <tbody id="rules_table">
                                </tbody>
                            </table>
                            <div id="rules_pagination"></div>
                        </div>                                           
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center">
                <div id="loading" class="spinner-border" style="width: 3rem; height: 3rem; display:none" role="status">
                </div>
            </div>

            <br />
            <br />
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

    <script>

        rules = [];
        contentTypes = [];
        contentType = '';
        options = '';
        conditions = [];
        pageSize = 10;

        function setContentTypesPagination(dataSource) {
            $('#contentTypes_pagination').pagination({
                dataSource: dataSource,
                pageSize: pageSize,
                showNavigator: true,
                formatNavigator: '<span style="color: black"> Total: <%= totalNumber %> </span>',
                callback: function (data, pagination) {
                    populateContentTypes(data)
                }
            })
        }

        function setRulesPagination(dataSource) {
            $('#rules_pagination').pagination({
                dataSource: dataSource,
                pageSize: pageSize,
                showNavigator: true,
                formatNavigator: '<span style="color: black"> Total: <%= totalNumber %> </span>',
                callback: function (data, pagination) {
                    populateRules(data)
                }
            })
        }

        function populateRules(dataSource) {
            let trHTML = '';
            $.each(dataSource, function (i, item) {

                let labelColor = '';
                let style = '';
                let icon = '';

                switch (item.status.toLowerCase()) {

                    case 'active':
                        labelColor = 'badge text-bg-success';
                        style = 'color: #1c6c09 !important;background-color: #d9fbd0 !important;'
                        icon = 'glyphicon glyphicon-ok';
                        break;
                    case 'pending':
                        labelColor = 'badge text-bg-info';
                        style = 'color: #bc3803 !important;background-color: #ffefca !important;'
                        icon = 'glyphicon glyphicon-time';
                        break;
                    default:
                        labelColor = 'badge text-bg-danger';
                        style = 'color: #AF0000 !important;background-color: #FFC8C8 !important;'
                        icon = 'glyphicon glyphicon-exclamation-sign';
                }

                trHTML += '<tr><th scope="row">' + item.priority + ' </th><td>' + item.name + '</td>';
                trHTML += '<td nowrap>' + item.dateBegin + '</td><td nowrap> ' + item.dateEnd + '</td>';
                trHTML += '<td>' + item.value + '</td>';
                trHTML += '<td style="text-align: center;"><span class="' + labelColor + '" style="' + style + '"> ';
                trHTML += item.status;
                trHTML += ' <span class="' + icon + '"></span> '
                trHTML += '</span></td>';
                trHTML += '<td nowrap style="text-align: center;"><button style="font-size:.875rem" type="button" class="btn btn-dark conditions"  ';
                trHTML += 'data-bs-toggle="modal" data-bs-target="#conditionsModal" title="Conditions" id="b' + item.priority + '">';
                trHTML += '<span class="glyphicon glyphicon-tasks" id="' + item.priority + '"></span>';
                trHTML += '</button></td></tr>';

            });
            $('#rules_table').html(trHTML);

            $("#loading").hide();
            setConditionsEvent();
        }

        function populateContentTypes(dataSource)
        {
            let trHTML = '';
            $.each(dataSource, function (i, item) {
                trHTML += '<tr><th scope="row">' + i + ' </th><td>' + item.name + '</td>';
                trHTML += '<td style="text-align: center;"><button style="font-size:.875rem" type="button" class="btn btn-dark rules"  ';
                trHTML += 'title="Rules" id="b' + item.name + '">';
                trHTML += '<span class="glyphicon glyphicon-search" id="' + item.name + '"></span>';
                trHTML += '</button></td>';
                trHTML += '</tr>';
            });
            $('#contentTypes_table').html(trHTML);
            $("#loading").hide();
            setContentTypesEvent();
        }

        function openError(error)
        {
            $('#errorModal').modal('show');
            $('#errorBody').html('<pre>' + JSON.stringify(error, null, '\t').
                replace(/\\r/g, '\r').
                replace(/\\n/g, '\n') + '</pre>');
        }

        function setContentTypesEvent()
        {
            $('.rules').on('click', function (e) {
                const contentTypeClicked = e.target.id;

                if (contentTypeClicked)
                {
                    contentType = contentTypeClicked;
                    $('#rules').click();
                }
            });
        }

        function setConditionsEvent()
        {
            $('.conditions').on('click', function (e) {
                let rule = rules.find(function (r)
                {
                    return r.priority == e.target.id || 'b' + r.priority == e.target.id;
                });

                const brs = '<br />';
                const noConditions = ' - No existing conditions - ';

                if (rule.conditions) {
                    jsonObj = JSON.parse(rule.conditions);
                    $('#string-tab-pane').html(brs + setStringView(jsonObj));
                    $('#json-tab-pane').html(brs + setJsonView(jsonObj));
                    $('#tree-tab-pane').html(brs + setTreeView(jsonObj));
                }
                else {
                    $('#string-tab-pane').html(brs + noConditions);
                    $('#json-tab-pane').html(brs + noConditions);
                    $('#tree-tab-pane').html(brs + noConditions);
                }
            });
        }

        function setJsonView(node) {

            let jsonPretty = JSON.stringify(node, null, '\t');

            return '<pre>' + jsonPretty + '</prep>';
        }

        function setStringView(node)
        {   
            let html = recursiveStringView(node);

            return html;
        }

        function recursiveStringView(node)
        {
            let html = '';

            if (!node) {
                return html;
            }

            if (node.ConditionType) {
                html += ' <i>' + node.ConditionType + '</i> (';

                html += node.Operator;
                html += ' ' + node.Operand;

                html += ')';

                return html;
            }

            if (node.LogicalOperator) {
                html += ' <b>' + node.LogicalOperator + '</b> ';

                if (node.ChildConditionNodes) {
                    html += ' (';

                    for (var i = 0; i < node.ChildConditionNodes.length; i++) {
                        html += recursiveStringView(node.ChildConditionNodes[i]);
                    }

                    html += ')';
                }

                return html;
            }

            return html;
        }

        function setTreeView(node) {
            let html = '<ul>';

            html += recursiveTreeView(node);

            html += '</ul>';

            return html;
        }

        function recursiveTreeView(node)
        {
            let html = '';

            if (!node) {                
                return html;
            }

            if (node.ConditionType) {
                html += '<li><span class="caret">' + node.ConditionType + '</span>';

                html += '<ul class="nested">';

                html += '<li>' + node.Operator + '</li>';
                html += '<li>' + node.Operand + '</li>';

                html += '</ul></li>';

                return html;
            }

            if (node.LogicalOperator) {                
                html += '<li><span class="caret"><b>' + node.LogicalOperator + '</b></span>';

                if (node.ChildConditionNodes) {
                    html += '<ul class="nested">';

                    for (var i = 0; i < node.ChildConditionNodes.length; i++) {
                        html += recursiveTreeView(node.ChildConditionNodes[i]);
                    }

                    html += '</ul></li>';
                }

                return html;
            }

            return html;
        }

        function setContentTypesSelectEvent()
        {
            $("#contentTypesSelect").on('change', function ()
            {
                $('#rules_table').html('');
                let contentTypeSelected = $(this).children("option:selected").val();
                contentType = '';

                if (contentTypeSelected)
                {
                    $("#loading").show();
                    $.ajax({
                        url:
                            "Rule/" + contentTypeSelected + "/List",
                        success: function (response) {
                            rules = response;
                            setRulesPagination(response);                            
                        },
                        error: function (error) {
                            $('#loading').hide();
                            $('#errorModal').modal('show');
                            $('#errorBody').html('<pre>' + JSON.stringify(error, null, '\t') + '</pre>');
                        }
                    });
                }
            });

            
        }

        $(document).ready(() => {
            $('#contentTypeSearch').on('input', function (e) {
                const contentTypeValue = $(this).val();
                if (contentTypeValue) {
                    let contentTypesFiltered = contentTypes.filter(function (r) {
                        return r.name.toLowerCase().includes(contentTypeValue.toLowerCase());
                    });

                    setContentTypesPagination(contentTypesFiltered);
                    return;
                }
                setContentTypesPagination(contentTypes);
                
            });

            $('.download').on('click', function ()
            {
                const rulesToExport = rules;
                for (var i = 0; i < rulesToExport.length; i++) {
                    let conditionsToExport = rulesToExport[i].conditions;
                                        
                    if (conditionsToExport) {
                        rulesToExport[i].conditions = JSON.parse(conditionsToExport);
                    }
                }
                const filename = "rules_as_json";
                const jsonStr = JSON.stringify(rulesToExport);

                let element = document.createElement('a');
                element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonStr));
                element.setAttribute('download', filename);

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            });

            $('.main .nav-link').on('click', function (d) {

                $('.main .nav-link.active').removeClass('active');

                $('.main .nav-link').addClass('text-white');

                $(this).addClass('active');
                $(this).addClass('text-white');
                $(this).attr("aria-current", "page");

                $('.content').hide();
                $('div[id=' + d.currentTarget.id + ']').show();

                $('#rulesOptions').html('Loading...');
                $.ajax({
                    url:
                        "Rule/Options",
                    success: function (response) {
                        $('#rulesOptions').html(response);
                    },
                    error: function (error) {
                        openError(error);
                    }
                });

                if (d.currentTarget.id == "contentTypes") {
                    setContentTypesPagination([]);
                    $("#loading").show();
                    $.ajax({
                        url:
                            "ContentType/List",
                        success: function (response) {
                            contentTypes = response;
                            setContentTypesPagination(response)
                            
                        },
                        error: function (error) {
                            openError(error);
                            $('#loading').hide();
                        }
                    });                    
                }

                if (d.currentTarget.id == "rules") {
                    $('#rules_table').html('');
                    setRulesPagination([]);
                    setContentTypesSelectEvent();
                    
                    let $dropdown = $("#contentTypesSelect");
                    $dropdown.html('<option value="">Loading...</option>');
                    $.ajax({
                        url:
                            "ContentType/List",
                        success: function (response) {
                            contentTypes = response;
                            $dropdown.html('<option value="">Choose ContentType...</option>');
                            $.each(response, function (i, item) {                                
                                if (contentType == item.name || contentType == 'b' + item.name) {
                                    $dropdown.append($("<option>", {
                                        value: item.name,
                                        text: item.name,
                                        selected: 'selected'
                                    }));
                                }
                                else
                                {
                                    $dropdown.append($("<option>", {
                                        value: item.name,
                                        text: item.name                                        
                                    }));
                                }
                            });

                            if (contentType)
                            {
                                $dropdown.change();
                            }
                        },
                        error: function (error) {
                            openError(error);
                        }
                    });
                    
                }            
            });            


        });
    </script>

    <div class="modal fade" id="errorModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Something went wrong</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">                    
                    <p><div id="errorBody"></div></p>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div class="modal fade" id="conditionsModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Conditions</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    
                </div>

                <!-- Modal body -->
                <div class="modal-body"> 
                    <ul class="nav nav-tabs" role="tablist">                        
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" aria-current="page" data-bs-target="#string-tab-pane" data-bs-toggle="tab" href="#">String</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#" data-bs-target="#json-tab-pane" data-bs-toggle="tab">Json</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#" data-bs-target="#tree-tab-pane" data-bs-toggle="tab">Tree</a>
                        </li>
                    </ul>

                    <div class="row"></div>
                    <div class="tab-content" id="myTabContent" style="max-height: 500px; overflow-y: auto; ">
                        <div class="tab-pane fade show active" id="string-tab-pane" role="tabpanel" aria-labelledby="string-tab" tabindex="0"></div>
                        <div class="tab-pane fade" id="json-tab-pane" role="tabpanel" aria-labelledby="json-tab" tabindex="1"></div>
                        <div class="tab-pane fade" id="tree-tab-pane" role="tabpanel" aria-labelledby="tree-tab" tabindex="2"></div>                        
                    </div>
                                    
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>
</body>
</html>
