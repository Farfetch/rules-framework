<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>%(DocumentTitle)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">


    <link rel='stylesheet' href='css/bootstrap.min.css' />

    <link rel='stylesheet' href='node_modules/glyphicons-only-bootstrap/css/bootstrap.min.css' />
    %(HeadContent)
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        html {
            height: -webkit-fill-available;
        }

        main {
            height: 100vh;
            height: -webkit-fill-available;
            max-height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .b-example-divider {
            border-width: 1px;
        }

        .b-example-vr {
            flex-shrink: 0;
            width: 1.5rem;
            height: 100vh;
        }
    </style>
</head>
<body>

    <main class="d-flex flex-nowrap">
        <div class="d-flex flex-column flex-shrink-0 p-3 text-bg-dark" style="width: 280px;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <span class="fs-4 glyphicon glyphicon-knight" aria-hidden="true"></span>
                &nbsp; <span class="fs-4"> %(DocumentTitle)</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" id="index" class="nav-link active" aria-current="page">
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" id="contentTypes" class="nav-link text-white">
                        Content Types
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" id="rules" class="nav-link text-white">
                        Rules
                    </a>
                </li>

            </ul>
            <hr>
        </div>

        <div class="b-example-divider b-example-vr"></div>

        <div class="container">
            <div class="py-5 text-center">
                <h2>%(DocumentTitle)</h2>
            </div>

            <center>
                <div id="index" class="content">
                    <p class="lead">Welcome to Rules.Framework UI. Allows you to see what are the content types and rules configured in this application.</p>
                </div>
            </center>

            <div id="contentTypes" class="content" style="display:none">
                <div class="row g-5">
                    <div class="col-12">
                        <h4 class="mb-3">Content Types</h4>
                        <form novalidate>

                            <hr class="my-4">

                        </form>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Name</th>
                                    </tr>
                                </thead>
                                <tbody id="conditionTypes_table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rules" class="content" style="display:none">
                <div class="row g-5">
                    <div class="col-12">
                        <h4 class="mb-3">Rules</h4>
                        <form novalidate>
                            <div class="row">
                                <div class="col-4">
                                    <select class="form-select" id="conditionTypesSelect" required>
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                            </div>

                            <hr class="my-4">

                        </form>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Date Start</th>
                                        <th scope="col">Date End</th>
                                        <th scope="col">Value</th>
                                        <th scope="col"></th>
                                        <th scope="col">Active</th>
                                    </tr>
                                </thead>
                                <tbody id="rules_table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center">
                <div id="loading" class="spinner-border" style="width: 3rem; height: 3rem; display:none" role="status">
                </div>
            </div>

        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

    <script>

        function openError(error)
        {
            $('#errorModal').modal('show');
            $('#errorBody').html('<p>' + JSON.stringify(error) + '</p>');
        }

        function setConditionsEvent()
        {
            $('.conditions').on('click', function (e) {                                
                let rule = rules.find(function (r)
                {
                    return r.id == e.target.id;
                });

                conditions = rule.conditions;

                if (conditions) {
                    let trHTML = '';
                    $.each(conditions, function (i, item) {
                        trHTML += '<tr><td>' + item.condition + ' </td><td>' + item.operator + '</td><td>' + item.value + '</td></tr>';
                    });
                    $('#conditions_table').html(trHTML);
                }
            });
        }

        function setConditionTypesEvent()
        {
            $("#conditionTypesSelect").on('change', function ()
            {
                $('#rules_table').html('');
                var selectedConditionType = $(this).children("option:selected").val();

                if (selectedConditionType)
                {
                    $("#loading").show();
                    $.ajax({
                        url:
                            "Rule/List",
                        success: function (response) {
                            rules = response;
                            let trHTML = '';
                            $.each(response, function (i, item) {

                                let checked = item.active ? 'checked' : '';

                                trHTML += '<tr><th scope="row">' + item.id + ' </th><td>' + item.name + '</td>';
                                trHTML += '<td>' + item.dateStart + '</td><td> ' + item.dateEnd + '</td>';
                                trHTML += '<td>' + item.value + '</td>';
                                trHTML += '<td><button type="button" class="btn btn-primary conditions" id="' + item.id + '" data-bs-toggle="modal" data-bs-target="#conditionsModal">';
                                trHTML += 'Conditions';
                                trHTML += '</button></td>';
                                trHTML += '<td><div class="form-check form-switch">';
                                trHTML += '<input class="form-check-input" type="checkbox" id="mySwitch" disabled name="darkmode" value="yes" ' + checked + '>';
                                trHTML += '</div></td></tr>';

                            });
                            $('#rules_table').html(trHTML);

                            setConditionsEvent();
                            $("#loading").hide();
                        },
                        error: function (error) {
                            $('#loading').hide();
                            $('#errorModal').modal('show');
                            $('#errorBody').html('<p>' + JSON.stringify(error) + '</p>');
                        }
                    });
                }
            });

            
        }

        $(document).ready(() => {
            rules = [];
            conditionTypes = [];
            conditions = [];
            $('.nav-link').on('click', function (d) {

                $('.nav-link.active').removeClass('active');

                $('.nav-link').addClass('text-white');

                $(this).addClass('active');
                $(this).addClass('text-white');
                $(this).attr("aria-current", "page");

                $('.content').hide();
                $('div[id=' + d.currentTarget.id + ']').show();

                if (d.currentTarget.id == "contentTypes") {
                    $("#loading").show();
                    $.ajax({
                        url:
                            "ContentType/List",
                        success: function (response) {
                            conditionTypes = response;
                            let trHTML = '';
                            $.each(response, function (i, item) {
                                trHTML += '<tr><th scope="row">' + i + ' </th><td>' + item.name + '</td></tr>';
                            });
                            $('#conditionTypes_table').html(trHTML);
                            $("#loading").hide();
                        },
                        error: function (error) {
                            openError(error);
                            $('#loading').hide();
                        }
                    });                    
                }

                if (d.currentTarget.id == "rules") {
                    $('#rules_table').html('');
                    setConditionTypesEvent();
                    let $dropdown = $("#conditionTypesSelect");
                    $dropdown.html('<option value="">Loading...</option>'); 
                    $.ajax({
                        url:
                            "ContentType/List",
                        success: function (response) {
                            conditionTypes = response;                            
                            $dropdown.html('<option value="">Choose ContentType...</option>');                            
                            $.each(response, function (i, item) {
                                $dropdown.append($("<option />").val(item.name).text(item.name));
                            });
                        },
                        error: function (error) {
                            openError(error);
                        }
                    });                    
                }            
            });            


        });
    </script>

    <div class="modal fade" id="errorModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Something went wrong</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">                    
                    <p><div id="errorBody"></div></p>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div class="modal fade" id="conditionsModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Conditions</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Condition</th>
                                    <th scope="col">Operator</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody id="conditions_table">                                                                
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>
</body>
</html>
